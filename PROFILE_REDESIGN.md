# 👤 PROFILE & FAVORITES REDESIGN

## Дата создания: 22 декабря 2025
## Статус: 📋 В разработке - ожидание утверждения

---

## 📊 АНАЛИЗ ТЕКУЩЕЙ СИТУАЦИИ

### Проблемы

#### 1. **Хаос в структуре профиля**
Сейчас существует **12 разных страниц профиля**:
- `/profile` - главная страница профиля
- `/profile/edit` - редактирование профиля
- `/profile/settings` - настройки
- `/profile/buildings` - мои объекты
- `/profile/reviews` - мои отзывы
- `/profile/routes` - мои маршруты
- `/profile/articles` - мои статьи
- `/profile/favorites` - избранные маршруты
- `/profile/saved-blogs` - сохраненные блоги
- `/profile/saved-news` - сохраненные новости
- `/profile/liked-blogs` - лайкнутые блоги
- `/profile/favorite-routes` - избранные маршруты

**Проблема:** Дублирование, непонятная структура, нет единообразия.

#### 2. **Путаница с действиями**
Сейчас есть несколько типов взаимодействия с контентом:
- ❤️ **Like** (лайк) - на блогах, новостях, маршрутах, объектах
- 🔖 **Save** (сохранить) - на блогах, новостях
- 📚 **Add to Collection** (добавить в коллекцию) - на объектах, маршрутах
- ⭐ **Favorite** (избранное) - на маршрутах

**Проблема:** 4 разных действия делают одно и то же - "сохраняют для потом". Это запутывает пользователя.

#### 3. **Коллекции - нужна новая роль**
Текущая система коллекций (`user_collections`, `collection_items`):
- Не имеет четкого отличия от избранного
- Нет workflow "избранное → коллекция"
- Нельзя делиться коллекциями

**Новая роль коллекций:**
- **Избранное** = быстрое сохранение (лайк)
- **Коллекции** = организованные тематические подборки
- **Сценарий:** Лайкнул → в избранном → добавил в коллекцию "Поездка в Порто"
- **Шаринг:** Можно делиться коллекциями с другими

#### 4. **UserDropdown перегружен**
В выпадающем меню профиля сейчас **10+ ссылок**:
- Мой профиль
- Редактировать профиль
- Мои объекты (5)
- Мои отзывы (12)
- Мои маршруты (3)
- Избранные маршруты (2)
- Избранные блоги (4)
- Сохраненные блоги (2)
- Настройки
- Админ панель (для модераторов)
- Выход

**Проблема:** Слишком много пунктов, сложная навигация.

---

## 🎯 ПРЕДЛАГАЕМОЕ РЕШЕНИЕ

### Философия
**"Лайкнул → Сохранил → Нашёл"**

Простая и понятная логика:
1. Пользователь лайкает контент (блог, новость, маршрут, объект)
2. Лайкнутое автоматически попадает в "Избранное"
3. В избранном можно фильтровать по типу контента

### Архитектура

#### 1. **Единая система Избранного**

**Одно действие - ❤️ Лайк:**
- Убрать: Save (сохранить), Add to Collection, Favorite
- Оставить: Like (лайк) - универсальное действие для всего контента

**Две страницы:**

**1. `/profile/favorites` - Избранное (приватное)**
```
/profile/favorites
  ├── ?type=all (по умолчанию - всё лайкнутое)
  ├── ?type=blogs (блоги)
  ├── ?type=news (новости)
  ├── ?type=routes (маршруты)
  └── ?type=buildings (объекты)
```
- Кнопка "Добавить в коллекцию" на каждой карточке
- Быстрый доступ ко всему лайкнутому

**2. `/profile/collections` - Коллекции (можно шарить)**
```
/profile/collections
  ├── Список моих коллекций
  ├── /collections/[id] - детальная страница коллекции
  │   ├── Все элементы коллекции (блоги, здания, новости, маршруты)
  │   ├── Кнопка "Поделиться коллекцией"
  │   └── Кнопка "Удалить из коллекции"
  └── Кнопка "Создать коллекцию"
```

**База данных:**

**Оставить и улучшить:**
- `user_collections` - добавить поле `is_public` BOOLEAN, `share_token` UUID
- `collection_items` - оставить как есть
- Добавить: `building_favorites` для лайков объектов

**Использовать для лайков:**
- `blog_reactions` (reaction_type='like')
- `news_reactions` (reaction_type='like')
- `user_route_favorites` (уже есть)
- `building_favorites` (создать новую)

**Удалить:**
- `blog_reactions` где reaction_type='save'
- `news_reactions` где reaction_type='save'

#### 2. **Упрощенная структура профиля**

**Основные разделы:**
```
/profile
  ├── Обзор (главная страница профиля)
  │
  ├── Мой контент
  │   ├── /profile/buildings - Мои объекты
  │   ├── /profile/routes - Мои маршруты
  │   ├── /profile/reviews - Мои отзывы
  │   └── /profile/articles - Мои блог-посты
  │
  ├── Избранное и Коллекции
  │   ├── /profile/favorites?type=... - Всё лайкнутое с фильтрами (приватное)
  │   └── /profile/collections - Мои коллекции (можно шарить)
  │       └── /collections/[id] - Детальная страница коллекции
  │       └── /collections/[id]/[share-token] - Публичный доступ к коллекции
  │
  └── Настройки
      ├── /profile/edit - Редактирование профиля
      └── /profile/settings - Настройки аккаунта
```

**Страницы для удаления:**
- ❌ `/profile/saved-blogs`
- ❌ `/profile/saved-news`
- ❌ `/profile/liked-blogs`
- ❌ `/profile/favorite-routes`

#### 3. **Упрощенный UserDropdown**

**Новая структура меню:**
```
┌─────────────────────────────────┐
│ [Аватар] Имя Пользователя      │
│ @username                       │
├─────────────────────────────────┤
│ 👤 Мой профиль                  │
│ ✏️  Редактировать профиль       │
├─────────────────────────────────┤
│ 🏛️  Мои объекты (5)            │
│ 🛣️  Мои маршруты (3)           │
│ ✍️  Мои отзывы (12)            │
│ 📰 Мои статьи (8)               │
├─────────────────────────────────┤
│ ❤️  Избранное (24)              │
│ 📚 Коллекции (3)                │
├─────────────────────────────────┤
│ ⚙️  Настройки                   │
│ 🛡️  Админ панель (если админ)   │
├─────────────────────────────────┤
│ 🚪 Выход                        │
└─────────────────────────────────┘
```

**Счетчики:**
- Мои объекты: `buildings_count`
- Мои маршруты: `routes_count`
- Мои отзывы: `reviews_count`
- Мои статьи: `articles_count` (blog_posts)
- **Избранное: `favorites_total_count`** (сумма всех лайков)
- **Коллекции: `collections_count`**

#### 4. **Страница `/profile/favorites`**

**Дизайн:**
```
┌───────────────────────────────────────────────┐
│                                               │
│  ❤️ Избранное                                 │
│                                               │
│  [Все] [Блоги] [Новости] [Маршруты] [Объекты]│
│  ───────────────────────────────────────────  │
│                                               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
│  │ Блог 1  │  │ Новость │  │ Маршрут │      │
│  │ ❤️ 234  │  │ ❤️ 156  │  │ ❤️ 89   │      │
│  └─────────┘  └─────────┘  └─────────┘      │
│                                               │
└───────────────────────────────────────────────┘
```

**Функционал:**
- Табы для фильтрации по типу контента
- Единый дизайн карточек (как в `/blog`, `/news` и т.д.)
- Сортировка: по дате лайка, по популярности
- Поиск внутри избранного
- Кнопка "Убрать из избранного" (= снять лайк)
- **Кнопка "Добавить в коллекцию"** - открывает модалку выбора коллекции

#### 5. **Страница `/profile/collections`**

**Дизайн списка коллекций:**
```
┌───────────────────────────────────────────────┐
│                                               │
│  📚 Мои коллекции                             │
│                                     [Создать] │
│  ───────────────────────────────────────────  │
│                                               │
│  ┌─────────────────────────────────────────┐ │
│  │ 🏛️ Поездка в Порто              [🔗]  │ │
│  │ 12 элементов • Создана 5 дней назад    │ │
│  │ 3 блога, 5 зданий, 2 новости, 2 маршр.│ │
│  └─────────────────────────────────────────┘ │
│                                               │
└───────────────────────────────────────────────┘
```

**Детальная страница `/collections/[id]`:**
- Заголовок коллекции (редактируемый)
- Описание коллекции (опционально)
- Кнопка "Поделиться" → генерирует ссылку с share_token
- Переключатель "Публичная коллекция" (вкл/выкл)
- Все элементы коллекции (микс из блогов, зданий, новостей, маршрутов)
- Кнопка "Удалить из коллекции" на каждом элементе
- Кнопка "Удалить коллекцию"

**Публичный доступ `/collections/[id]/[share-token]`:**
- Любой пользователь (даже неавторизованный) может просмотреть
- Read-only режим (нельзя редактировать)
- Показывается автор коллекции
- Кнопка "Скопировать в мои коллекции" для авторизованных

---

## 🎨 ДИЗАЙН-СИСТЕМА

### Применение существующих паттернов

Использовать дизайн из **DESIGN_MIGRATION_PROGRESS.md**:

#### Компоненты
- **Tabs** - для фильтров типов (Все, Блоги, Новости, Маршруты, Объекты)
- **Cards** - BlogCard, NewsCard стили для карточек контента
- **Badges** - rounded-full для категорий и типов
- **Buttons** - `rounded-[var(--radius)]` для действий

#### Цвета
- **Primary** - для лайков и акцентов
- **bg-card** - фон карточек
- **border-border** - границы
- **text-foreground** - основной текст
- **text-muted-foreground** - вторичный текст

#### Шрифты
- **Rubik** (`font-sans`) - основной текст
- **Rubik** (`font-display`) - заголовки
- **Geologica** (`font-metrics`) - счетчики и метрики

---

## 🗄️ БАЗА ДАННЫХ

### Изменения

#### Таблицы для улучшения (коллекции остаются!)
```sql
-- Улучшить user_collections - добавить шаринг
ALTER TABLE user_collections ADD COLUMN IF NOT EXISTS is_public BOOLEAN DEFAULT false;
ALTER TABLE user_collections ADD COLUMN IF NOT EXISTS share_token UUID DEFAULT gen_random_uuid();
ALTER TABLE user_collections ADD COLUMN IF NOT EXISTS description TEXT;

-- Создать индекс для share_token
CREATE INDEX IF NOT EXISTS idx_user_collections_share_token ON user_collections(share_token);

-- RLS политика для публичных коллекций (по share_token)
CREATE POLICY "Anyone can view public collections with share token"
ON user_collections FOR SELECT
TO public
USING (is_public = true);

-- Коллекции можно просматривать по share_token даже если не авторизован
CREATE POLICY "Anyone can view collection by share token"
ON user_collections FOR SELECT
TO anon
USING (share_token IS NOT NULL);

COMMENT ON COLUMN user_collections.is_public IS 'Можно ли делиться коллекцией';
COMMENT ON COLUMN user_collections.share_token IS 'Уникальный токен для шаринга коллекции';
```

#### Таблицы для создания
```sql
-- Создать таблицу избранных объектов (по аналогии с user_route_favorites)
CREATE TABLE IF NOT EXISTS building_favorites (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  building_id UUID NOT NULL REFERENCES buildings(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, building_id)
);

-- RLS политики
ALTER TABLE building_favorites ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own favorites"
ON building_favorites FOR SELECT
TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Users can add their own favorites"
ON building_favorites FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can remove their own favorites"
ON building_favorites FOR DELETE
TO authenticated
USING (auth.uid() = user_id);

-- Индекс для производительности
CREATE INDEX idx_building_favorites_user_id ON building_favorites(user_id);
CREATE INDEX idx_building_favorites_building_id ON building_favorites(building_id);
```

#### Обновление существующих таблиц
```sql
-- Удалить reaction_type='save' из blog_reactions и news_reactions
DELETE FROM blog_reactions WHERE reaction_type = 'save';
DELETE FROM news_reactions WHERE reaction_type = 'save';

-- Оставить только reaction_type='like'
-- Можно добавить constraint если нужно:
ALTER TABLE blog_reactions DROP CONSTRAINT IF EXISTS blog_reactions_type_check;
ALTER TABLE blog_reactions ADD CONSTRAINT blog_reactions_type_check
  CHECK (reaction_type = 'like');

ALTER TABLE news_reactions DROP CONSTRAINT IF EXISTS news_reactions_type_check;
ALTER TABLE news_reactions ADD CONSTRAINT news_reactions_type_check
  CHECK (reaction_type = 'like');
```

---

## 🔧 КОМПОНЕНТЫ

### 1. **FavoritesPage** (`/src/app/profile/favorites/page.tsx`)

Новый компонент страницы избранного.

**Структура:**
```typescript
interface FavoriteItem {
  id: string
  type: 'blog' | 'news' | 'route' | 'building'
  item_id: string
  created_at: string
  // + данные самого элемента (title, image, etc.)
}

export default function FavoritesPage() {
  const [activeTab, setActiveTab] = useState<'all' | 'blogs' | 'news' | 'routes' | 'buildings'>('all')
  const [favorites, setFavorites] = useState<FavoriteItem[]>([])
  const [loading, setLoading] = useState(true)

  // Загрузка избранного из всех 4 источников
  // Фильтрация по типу
  // Сортировка
  // Render карточек
}
```

### 2. **UpdatedUserDropdown** (`/src/components/UserDropdown.tsx`)

Обновить существующий компонент.

**Изменения:**
- Убрать: `liked_blogs_count`, `saved_blogs_count`, `collections_count`, `pending_requests_count`
- Добавить: `favorites_total_count`, `articles_count`
- Упростить навигацию до 9 пунктов

### 3. **LikeButton** (универсальный компонент)

Создать единый компонент для лайков всех типов контента.

```typescript
interface LikeButtonProps {
  type: 'blog' | 'news' | 'route' | 'building'
  itemId: string
  initialLiked?: boolean
  initialCount?: number
  className?: string
}

export default function LikeButton({ type, itemId, ... }) {
  // Универсальная логика лайков
  // Работает с blog_reactions, news_reactions, user_route_favorites, building_favorites
}
```

### 4. **Обновленные карточки**

Убрать кнопку "Save" / "Add to Collection", оставить только "Like":
- `BlogCard.tsx` - убрать Save
- `NewsCard.tsx` - убрать Save
- Карточки маршрутов - заменить Favorite на Like
- Карточки объектов - убрать Add to Collection, добавить Like

---

## 🚀 ПЛАН МИГРАЦИИ

### Фаза 1: Подготовка (1-2 часа)
- [x] Создать документ PROFILE_REDESIGN.md
- [ ] Утвердить план с пользователем
- [ ] Создать резервную копию БД
- [ ] Создать новую ветку git: `feature/profile-redesign`

### Фаза 2: База данных (2-3 часа)
- [ ] Создать миграцию `032_enhance_favorites_and_collections.sql`
- [ ] Создать таблицу `building_favorites`
- [ ] **Улучшить user_collections** - добавить is_public, share_token, description
- [ ] Создать RLS политики для публичных коллекций
- [ ] Очистить `blog_reactions` и `news_reactions` от 'save'
- [ ] Применить миграцию
- [ ] Проверить целостность данных

### Фаза 3: Компоненты избранного (3-4 часа)
- [ ] Создать универсальный `LikeButton` компонент
- [ ] Создать страницу `/profile/favorites` с фильтрами
- [ ] Создать модалку `AddToCollectionModal` (выбор коллекции)
- [ ] Обновить карточки (BlogCard, NewsCard) - убрать Save, оставить Like
- [ ] Удалить старые страницы (saved-blogs, saved-news, liked-blogs, favorite-routes)

### Фаза 4: Компоненты коллекций (4-5 часов)
- [ ] Обновить страницу `/profile/collections` (список коллекций)
- [ ] Создать страницу `/collections/[id]` (детальная страница)
- [ ] Создать страницу `/collections/[id]/[share-token]` (публичный доступ)
- [ ] Создать модалку `CreateCollectionModal`
- [ ] Создать модалку `ShareCollectionModal` (генерация ссылки)
- [ ] Добавить функционал "Скопировать коллекцию"

### Фаза 5: Навигация и UserDropdown (2-3 часа)
- [ ] Обновить `UserDropdown` - новая структура меню (10 пунктов)
- [ ] Добавить счетчики: favorites_total_count, collections_count
- [ ] Настроить редиректы со старых URL на новые
- [ ] Обновить мобильное меню Header

### Фаза 6: Тестирование (3-4 часа)
- [ ] Проверить работу лайков на всех типах контента
- [ ] Проверить страницу избранного с фильтрами
- [ ] Проверить создание коллекций
- [ ] Проверить добавление в коллекцию из избранного
- [ ] Проверить шаринг коллекций (публичные ссылки)
- [ ] Проверить "Скопировать коллекцию"
- [ ] Проверить UserDropdown и навигацию
- [ ] Проверить адаптивность на мобильных
- [ ] Проверить что старые URL редиректят

### Фаза 7: Админ панель с аналитикой (5-6 часов)
- [ ] Структурировать `/admin`
- [ ] Создать единый дашборд
- [ ] Упорядочить разделы модерации
- [ ] Применить дизайн-систему

### Фаза 8: Финальная полировка (1-2 часа)
- [ ] Обновить документацию
- [ ] Очистить неиспользуемый код
- [ ] Проверить производительность
- [ ] Code review
- [ ] Merge в main

**Общее время: ~20-25 часов** (с учетом коллекций и аналитики)

---

## 📝 АДМИН ПАНЕЛЬ - СТРУКТУРА

### Текущие проблемы
- Разрозненные страницы: `/admin`, `/admin/moderation`, `/admin/users`
- Нет единого дашборда
- Нет навигации между разделами

### Предлагаемая структура

```
/admin
  ├── Dashboard (главная)
  │   ├── Статистика (всего пользователей, объектов, маршрутов)
  │   ├── Недавняя активность
  │   └── Быстрые действия
  │
  ├── Модерация (/admin/moderation)
  │   ├── Объекты на модерации
  │   ├── Маршруты на модерации
  │   └── Отзывы на модерации
  │
  ├── Пользователи (/admin/users)
  │   ├── Список пользователей
  │   ├── Роли и права
  │   └── Заблокированные
  │
  ├── Контент (/admin/content)
  │   ├── Блоги
  │   ├── Новости
  │   └── Подкасты
  │
  └── Настройки (/admin/settings)
      ├── Общие настройки
      └── Управление доступом
```

**Дизайн:**
- Sidebar с навигацией (скрытый на мобильных)
- Единый layout для всех админ страниц
- Применить дизайн-систему (bg-card, border-border и т.д.)
- Stats cards с `font-metrics` для цифр
- Таблицы с сортировкой и фильтрацией

---

## ✅ ОТВЕТЫ НА ВОПРОСЫ (получены от пользователя)

1. **Коллекции:**
   - ✅ **ОСТАВИТЬ** с новой логикой
   - **Сценарий:** Пользователь лайкает контент → попадает в избранное → из избранного добавляет в коллекцию
   - **Пример:** Планирование поездки в Порто - собрать блоги, здания, новости в одну коллекцию "Поездка в Порто"
   - **Шаринг:** Коллекциями можно делиться

2. **Статьи пользователя:**
   - ✅ Это статьи блога (`blog_posts`), созданные пользователем
   - Страница `/profile/articles` для управления своими блог-постами

3. **Избранное - приватность:**
   - ✅ Избранное приватное (только для владельца)
   - ✅ Коллекции можно делать публичными и шарить

4. **Уведомления:**
   - ✅ Только для комментариев
   - ❌ НЕ отправлять при лайках

5. **Миграция данных:**
   - ✅ Не важна, сайт в тестовом режиме
   - Можно просто удалить старые "save"

6. **Админ панель - Аналитика:**
   - ✅ Нужна
   - **Предлагаемые метрики:**
     - 📊 Общая статистика (пользователи, объекты, маршруты, контент)
     - 📈 Графики роста по дням/неделям/месяцам
     - 🔥 Топ контента (самые популярные объекты, маршруты, статьи)
     - 👥 Активные пользователи (за день/неделю/месяц)
     - 🗺️ География (города, страны с наибольшим контентом)
     - ⚡ Активность (новые объекты/маршруты/отзывы за период)
     - 🎯 Конверсии (регистрации → создание контента → публикация)

---

## 🎯 ОЖИДАЕМЫЙ РЕЗУЛЬТАТ

### Для пользователя
- ✅ Простая и понятная система: "Лайкнул → Сохранил → Нашёл"
- ✅ Одна страница избранного вместо 4+ разных
- ✅ Меньше кликов для доступа к контенту
- ✅ Чистый и структурированный профиль
- ✅ Единообразный дизайн

### Для разработки
- ✅ Меньше кода (удаление коллекций)
- ✅ Проще поддержка (один тип взаимодействия)
- ✅ Меньше таблиц в БД
- ✅ Единый компонент лайков
- ✅ Лучшая производительность

### Для модераторов
- ✅ Структурированная админ панель
- ✅ Единый дашборд
- ✅ Быстрый доступ ко всем функциям

---

## 📚 ССЫЛКИ

- [DESIGN_MIGRATION_PROGRESS.md](./DESIGN_MIGRATION_PROGRESS.md) - дизайн-система
- [CLAUDE.md](./CLAUDE.md) - архитектурные паттерны проекта
- Design/src/pages/Settings.tsx - референс дизайна настроек

---

**Статус:** ✅ Утверждено - готов к реализации
**Последнее обновление:** 22 декабря 2025, 23:45

---

## 🎬 КРАТКИЙ SUMMARY

### Что делаем:
1. ✅ **Лайк вместо Save** - одно действие для всего контента
2. ✅ **Избранное** - приватная страница со всем лайкнутым (с фильтрами)
3. ✅ **Коллекции** - тематические подборки, можно шарить
4. ✅ **UserDropdown** - 10 пунктов вместо 12+
5. ✅ **Админ панель** - с дашбордом и аналитикой

### Workflow:
```
Контент → Лайк → Избранное → Добавить в коллекцию → Поделиться
```

### Ключевые фичи:
- 📱 Публичные коллекции по share-token
- 📊 Аналитика в админке (графики, топы, география)
- 🎨 Единый дизайн по DESIGN_MIGRATION_PROGRESS.md
- ❤️ Универсальный LikeButton для всех типов
- 📚 Коллекции-подборки для планирования поездок
